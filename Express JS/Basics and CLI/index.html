<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title> Basics and CLI </title> 
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../../Assets/stylesPages.css"> 
    <script src="../../Assets/scriptPages.js"></script>
</head>
<body>
<h1> Basics and CLI (ver 4.0.0) </h1>
    <p> Updated ( 2021-01-28 )</p>
    <p class="sitenav"> <a href="../../index.html" title="home">MySite></a>
        <a href="../index.html">Express JS></a> Basics and CLI  
    </p>
<table class="table">
<caption> 
    Expressjs CLI 
    <span class="changeListOrder">[Ordered: <span>Alphabetically</span>]</span>
</caption>
    <tr>
        <th style="width:30%;"> CLI </th>
        <th> Description </th>
    </tr>
    <tr class="1.1">
        <td> <em>npm</em> install express </td>
        <td> - installs expressjs (locally) </td>
    </tr>
    <tr class="1.2">
        <td> <em>npx</em> express-generator </td>
        <td>  
            - creates an <span class="openable">app directory structure<div>
                <p> <mark>public/</mark> </p>
                <p> <mark>public/javascripts/</mark> </p>
                <p> <mark>public/images/</mark> </p>
                <p> <mark>public/stylesheets/</mark> </p>
                <p> <mark>public/stylesheets/style.css</mark> </p>
                <p> <mark>routes/</mark> </p>
                <p> <mark>routes/index.js</mark> </p>
                <p> <mark>routes/users.js</mark> </p>
                <p> <mark>views/</mark> </p>
                <p> <mark>views/error.jade</mark> </p>
                <p> <mark>views/index.jade</mark> </p>
                <p> <mark>views/layout.jade</mark> </p>
                <p> <mark>app.js</mark> </p>
                <p> <mark>package.json</mark> </p>
                <p> <mark>bin/</mark> </p>
                <p> <mark>bin/www</mark> </p>
            </div></span> (then we can run <mark>$ npm install</mark> which installs the application skeleton)
        </td>
    </tr>
</table>
    <br>
<table class="table">
<caption> 
    Route Paths and Parameters 
    <span class="changeListOrder">[Ordered: <span>Alphabetically</span>]</span>
</caption>
    <tr>
        <th style="width:30%;"> Route </th>
        <th> Description </th>
    </tr>
    <tr class="1.1">
        <td> <strong>routePath</strong> </td>
        <td>  
            - describes a route to the communication endpoint <u>(query strings are not part of the route path)</u> <br>
            - can be a <span class="openable"><u>string</u>, <u>string pattern</u> or <u>regular expression</u><div>
            <p><b><u> String </u></b></p>
            <p> - matches a regular string </p>
            <hr>
            <p><b><u> String Patter </u></b></p>
            <p> - the <mark>+</mark> <mark>?</mark>and <mark>()</mark> characters are used just like in Regular Expression </p>
            <p><u> - the <mark>*</mark> character used as globe (Different than in Regular Expression! = matches any characters zero or more times)</u> </p>
            <p> - the <mark>$</mark> character can be use as <mark>([\$])</mark> </p>
            <p> - - example: </p>
            <p> <mark>'some*Path'</mark> matches = <mark>somePath</mark> | <mark>someMorePath</mark> | <mark>some2134Path</mark> <u>(not the same as RegExp)</u></p>
            <p> <mark>'some+Path'</mark> matches = <mark>somePath</mark> | <mark>someeeePath</mark> </p>
            <p> <mark>'some?Path'</mark> matches = <mark>somPath</mark> | <mark>somePath</mark> </p>
            <p> <mark>'so(me)?Path'</mark> matches = <mark>soPath</mark> | <mark>somePath</mark> </p>
            <p> <mark>'some([$])Path'</mark> matches = <mark>some$Path</mark> </p>
            <hr>
            <p><b><u> Regular Expression </u></b></p>
            <p> - regular expression </p>
            <p> - - example: </p>
            <p> <mark>'some*Path'</mark> matches = <mark>somPath</mark> | <mark>somePath</mark> | <mark>someeePath</mark> </p>
            </div></span> 
        </td>
    </tr>
    <tr class="1.2">
        <td> <strong>routePath</strong>:<strong>param</strong>/|-|.<i>routePath</i> </td>
        <td>  
            - route parameters in the <strong>routePath</strong> pass their values to <mark>req.params</mark> object <br>
            - accept (<mark>a-zA-Z0-9_</mark>) characters, starts with a <mark>:</mark> character and ends with a <mark>/</mark> or <mark>-</mark> or <mark>.</mark> character  
        </td>
    </tr>
</table>
<h2 style="color:green;"><u> Notes : </u></h2>
    <details class="example" id="notes">
    <summary> Notes :</summary>
        <!-- <p> - paragraph removes the 'empty' message from the detail TAG -->
    </details>
<h2 style="color:green;"><u> Useful Links : </u></h2>
    <p><a href="https://expressjs.com/" target="_blanc">Express (expressjs.com)</a></p>
<h2 style="color:green;"><u> Remember This : </u></h2>
    <p> - the <mark>*</mark> (asterisk) character is interpreted differently when used in string patterns and in regular expressions (in string patters = globe (matches zero or more any characters)) (in regular expressions = matches zero or more times the preciding character) </p>
<h2 style="color:green;"><u> Description and Demonstration : </u></h2>
    <p> - Express.js is a fast, unopignonated, minimalist web server framework for Node.js (simplifies HTTP server building) </p>
<hr>
<!------------------------------------------------------------------------------------------------>
<h2 class="headerExtra"><u> Routing and Middleware </u></h2>
    <p> - Express.js is build around 2 main concepts Routing and Middleware </p>
    <p> - Routing is essentially routing the traffic from the client to a particular endpoint </p>
    <p> - Middlewares are essentially functions executed on this route (performing various operations) </p>
    <p> - the basic concept is "routing" the incomming traffic through various middlewares that deal with the traffic </p> 
    <p> - both the <mark>app</mark> and <mark>router</mark> keep individual middleware stacks, <u>middlewares are executed in the stack order</u> (this means if a middleware in the stack ends the request/response life-cycle the remaining middlewares are ignored!) </p>
    <pre>
    const express = require('express');
    const app = express();
        
// middleware function structure ------------------------------------------------------
    var someMiddleware = function(req, res, next){
        req, res;                                                                      // every middleware function receives the Request and Response objects   
        
      // next() ----------------------------------------
        next();                                                                        // skip the rest of this middleware and calls the next one in the stack    
        
        next('route');                                                                 // skip the remaining middlewares on this route and call the next route      
                                                                                       // !! does not work middlewares used in 'app.use()' and 'router.use()' methods    
                                                                                       
        next(err);                                                                     // asynchronous errors should be passed so Expressjs can handle them   
    }
    
// middleware stack -------------------------------------------------------------------
    app.use('/',
        function(req, res, next){ next(); },                                           // calls the next middleware in the stack  
        function(req, res, next){ res.send('OK') },                                    // middleware end the request/response life-cycle 
        function(req, res, next){ console.log('END?') },                               // this last middleware never executed in the stack  
    );
    
    app.listen(1000, ()=> console.log('Expressjs is listening!'))
    </pre>
    <p> - a middleware function can: </p>
    <p style="text-indent:30px;"> - execute any code </p>
    <p style="text-indent:30px;"> - modify the <mark>req</mark> (Request) and <mark>res</mark> (Response) objects </p>
    <p style="text-indent:30px;"> - call the next middleware in the stack </p>
    <p style="text-indent:30px;"> - end the request/response life-cycle </p>
    <p> - middleware types: </p>
    <p style="text-indent:30px;"> - application-level middleware (middlewares attached to the <mark>app</mark> (application) stack) </p>
    <p style="text-indent:30px;"> - router-level middleware (middlewares attached to the <mark>router</mark> stack) </p>
    <p style="text-indent:30px;"> - error handling middleware (usually the last middleware in the stack) </p>
    <p style="text-indent:30px;"> - built-in middleware (like: <mark>express.static()</mark>, <mark>express.json()</mark> body parsers) </p>
    <p style="text-indent:30px;"> - third party middleware (external module like: <mark>cookie-parser</mark>) </p>
<details class="example">
<summary> DEMO </summary>
    <p> - a middleware can </p>
    <pre>
    const express = require('express');
    const app = express();
    
    app.use('/', 
        express.text(),                                                                // this built-in middleware modifies the incomming request object so the content can be read ast text    
        function(req, res, next) {
            console.log('something');                                                  // executing code 
            next();                                                                    // calls the next middelware in the stack  
        }, 
        function(req, res, next){
            res.send('OK');                                                            // ends the request/response life-cycle 
        }
    );
    </pre>
    <p> - middleware types </p>
    <pre>
    const express = require('express');
    const cookieParser = require('cookie-parser');
    const app = express();
    const router = express.Router();
    
    app.use('/', 
        cookieParser(),                                                                // thrid-party middleware (parses cookies)
        express.text(),                                                                // built-in middleware modifies the incomming request object so the content can be read ast text    
        function(req, res, next) {                                                     // application-level middleware 
            // do something...                           
            next(); 
        }, 
        router
    );  
        
    router.use('/sub',
        function(req, res, next){                                                      // router-level middleware  
            res.send('OK');
        },
        function(err, req, res, next){                                                 // error handling middleware 
            if(err) console.log(err)
        }
    )
    </pre>
    <p> - using <mark>next()</mark> in middlewares </p>
    <pre>
    const express = require('express');
    const app = express();
    const fs = require('fs');
    
// next() -----------------------------------------------------------------------------
    app.all('/', 
        (req, res, next) => { next() },                                                // calls the next middleware in the stack 
        (req, res, next) => { res.send('OK') }                                           // called
    );
    
// next('route')-----------------------------------------------------------------------
    app.all('/', 
        (req, res, next) => { next('route') },                                         // calls the next route 
        (req, res, next) => { next() },                                                  // ignored
        (req, res, next) => { next() }                                                   // ignored 
    );
    
    app.all('/', 
        (req, res, next) => { next() },                                                  // called 
        (req, res, next) => { res.send('OK!') }                                          // called 
    );
    
  // ---------------------------
    app.use('/', 
        (req, res, next) => { next('route') },                                         // !! does not call the next route in 'use()' methods (same as 'next()')    
        (req, res, next) => { next() },                                                  // called   
        (req, res, next) => { next() }                                                   // called    
    );
    
    app.all('/', 
        (req, res, next) => { next() },                                                  // called 
        (req, res, next) => { res.send('OK!') }                                          // called 
    );
    
// next(err) --------------------------------------------------------------------------
    app.use('/', function(req, res, next) {
        fs.readFile('noFile', function(err){
            next(err)                                                                  // in asynchronous tasks the error should be passed to it so Express can throw it   
        });
    });
    </pre>
</details>
<hr>
<!---------------------------------------------------------------------------------------------------->
<h2 style="color:darkblue;"><u> Route Paths and Parameters </u></h2>
<details class="example">
<summary> DEMO </summary>
    <p> string patters VS regular expression as path </p>
    <pre>
// * ----------------------------------------------------------------------------------
    app.all('/some*Path', middleware});                                                // matches 'some(zero or more any chararacters)Path'    // !! used as globe = different than RegExp    
                                                                                         // ex: '/somePath' | '/somemorePath' | '/some458Path' 
    
    app.all(/\/some*Path/, middleware});                                               // matches 'som(zero or more 'e' characters)Path' 
                                                                                         // ex: 'somPath' / 'somePath' / 'someeeePath' 
                                                                                          
// + ----------------------------------------------------------------------------------
    app.all('/some+Path', middleware});                                                // matches 'some(one or more 'e' characters)Path'       // -! same as in RegExp  
                                                                                         // ex: '/somePath' | '/someeeeePath' 
                                                                                         
    app.all(/\/some+Path/, middleware});                                               // matches 'some(one or more 'e' characters)Path'   
                                                                                          // ex: '/somePath' | '/someeeeePath' 
    
// ? ----------------------------------------------------------------------------------
    app.all('/some?Path', middleware});                                                // matches 'some(zero or one 'e' character)Path'        // -! same as in RegExp  
                                                                                         // ex: '/somPath' | '/somePath' 
                                                                                         
    app.all(/\/some+Path/, middleware});                                               // matches 'some(zero or one 'e' character)Path'
                                                                                         // ex: '/somPath' | '/somePath' 
    </pre>
    <p> - route path parameters </p>
    <pre>
    const express = require('express');
    const app = express();
    
    app.use('/:base/:sub1', function(req, res, next){                                  // request URL is 'localhost:1000/basePath/subPath'
        req.params;                                                                    // -> {base:'basePath', sub1:'subPath'}
    })
    
    app.use('/user/:userName-:userId/:time.:minute', function(req, res, next){         // request URL is 'localhost:1000/user/pall-21/14.16'
        req.params;                                                                    // -> {userName:'pall', userId:'21', time:'14', minute:'16'} 
    })
    
    app.listen(1000, ()=> console.log('Expressjs is listening!'))
    </pre>    
</details>
<details class="example">
<summary> Example : </summary>
<h4 style="color:darkblue;"><u> route parameter TEST </u></h4>
    <pre>
    const express = require('express');
    const app = express();
    
// ------------------------------------------------------------------------------------
    app.use('/:base/:sub1', function(req, res, next){                                  // request URL is 'localhost:1000/basePath/subPath'
        console.log( req.params );                                                     // -> {base:'basePath', sub1:'subPath'}
        res.send('OK!');
    })
    
// ------------------------------------------------------------------------------------
    app.use('/user/:userName-:userId/:time.:minute', function(req, res, next){         // request URL is 'localhost:1000/user/pall-21/14.16'
        console.log( req.params );                                                     // -> {userName:'pall', userId:'21', time:'14', minute:'16'} 
        res.send('OK!');
    })
    
    app.listen(1000, ()=> console.log('Expressjs is listening!'))
    </pre>    
</details>
<hr>
<!---------------------------------------------------------------------------------------------------->
<h2 style="color:darkblue;"><u> Error Handling </u></h2>
    <p> - the built-in Expressjs error handler notifies the client (responds with an Error webpage) about <u>an error thrown in a middleware</u> </p>
    <p> - the default Expressjs error handler can be overriden by passing an error handler middleware at the end of the middleware stack </p> 
    <p> - the error handler can handle synchronous Errors but <u>cannot handle asynchronous Errors on its own</u>, we manually must pass the error in the <mark>next()</mark> middleware callback for this </p>
    <pre class="syntax">
SYNTAX:     function(err, req, res, next){ }                                           // error handler middleware receives the thrown <mark>err</mark> (Error) that is thrown in the middleware stack   
                                                                                          should be mounted as last middleware in the stack  
    </pre>
<details class="example">
<summary> DEMO </summary>
    <p> - built-in Expressjs error handler mechanism </p>
    <pre>
    const express = require('express');
    const app = express();
    const fs = require('fs');
    
// synchronous error in middleware ----------------------------------------------------
    app.use('/', function(req, res, next){  
        throw Error('pallError');                                                      // Expressjs automatically responds to the client with the caught Error and the callstack (as basic webpage)     
    })
    
// unhandled asynchronous error in middleware (Don't do this) -------------------------
    app.use('/', function(req, res, next){
        fs.readFile('nofile', function(err, data){
            err                                                                        // -! Expressjs cannot handle asynchronous errors so the default Express error handler is not tirggered in this case    
        })
    })
    
// handling asynchornous errors -------------------------------------------------------
    app.use('/', function(req, res, next){
        fs.readFile('nofile', function(err, data){
            next(err);                                                                 // Expressjs is notified about asynchrnous errors this way (so the Express error handler can kick in)    
        })
    })
    </pre>  
    <p> - error handler middleware (custom error handling) </p>
    <pre>
    const express = require('express');
    const app = express();
    const fs = require('fs');
    
    app.use('/', function(req, res, next){
        fs.readFile('nofile', function(err, data){
            next(err)                                                                  // asynchronous errors must always be passed 
        })
    }, function(err, req, res, next){                                                  // error handler middleware should be mounted at the end 
        console.log(err.message);                                                      // -> 'no such file or directory'
        res.send('Error Occured!')                                                     // we can decied how to handle the thrown error here (synchronous errors are handled this way too!)    
    });
    </pre>
</details>    
<details class="example">
<summary> Example : </summary>
<h4 style="color:darkblue;"><u> asynchronous error handling TEST </u></h4>
    <pre>
    const express = require('express');
    const app = express();
    const fs = require('fs')
    
// no Expressjs error handler triggered -----------------------------------------------
    app.use('/', function(req, res, next){
        fs.readFile('noFile', function(err){
            console.log(err)                                                           // the asynchronous error is thrown here but the Expressjs error handler is not triggered    
        })
    })
    
// Expressjs error handler triggered --------------------------------------------------
    app.use('/', function(req, res, next){
        fs.readFile('noFile', function(err){
            next(err);                                                                 // the asynchronous error is passed to the Expressjs error handler this way   
        })
    })
    
// Custom Expressjs error handler -----------------------------------------------------
    app.use('/', function(req, res, next){
        fs.readFile('noFile', function(err){
            next(err);                                                                 // the asynchronous error is passed to the Expressjs error handler this way   
        })
    }, function(err, req, res, next){                                                  // custom Expressjs error handler middleware 
        console.log(err.message);                                                      // -> 'No such file or directory'
        res.send('Error Occured!')
    });
    
// Custom Expressjs error handler (synchronous error) ---------------------------------
    app.use('/', function(req, res, next){
        try{
            throw Error('myError')
        } catch(err){
            next(err);                                                                 // the thrown Error is passed to the Expressjs error handler   
        }
    }, function(err, req, res, next){                                                  // custom Expressjs error handler middleware 
        console.log(err.message);                                                      // -> 'myError'
        res.send('Error Occured!')
    });
    
    app.listen(1000, ()=> console.log('Expressjs is listening!'))
    </pre>
</details>
<hr>
<!---------------------------------------------------------------------------------------------------->
<h2 style="color:darkblue;"><u> Using ExpressJS through HTTPS and HTTP/2 </u></h2>
    <p> - Expressjs does not support HTTPS on its own but the <mark>app</mark> object is designed to be passed as callback in <mark>http.createServer()</mark> and <mark>https.createServer()</mark> making Express functionalities available throgh these native Node servers </p>
    <p> - however the <mark>app</mark> object cannot be passed as callback in <mark>http2.createServer()</mark> and <mark>http2.createSecureServer()</mark> methods, so Node.js does not natively support Express through http/2 protocols [TESTED Express.js v4.17.1]</p>
    <p> - if we want to use Express through HTTP/2 the <mark>spdy</mark> module allows this [TESTED Express.js v4.17.1 / spdy v4.0.2]</p>    
<details class="example">
<summary> DEMO </summary>
    <p> - using Express.js thorugh <mark>http</mark> native Node server </p>
    <pre>
    const http = require('http')
    const express = require('express');
    const app = express();
    
    app.use('/', express.static('/home/pall/Documents/CodePlus/My Site'));
    
    const server = http.createServer(app);                                             // Express app object passed as callback here 
    
    server.listen(1000, ()=> console.log('Node server is listening!'));
    </pre>
    <p> - using Express.js thorugh <mark>https</mark> native Node server </p>
    <pre>
    const fs = require('fs')
    const https = require('https')
    const express = require('express');
    const app = express();
    
    app.use('/', express.static('/home/pall/Documents/CodePlus/My Site'));
    
    var options = {
        key: fs.readFileSync('./cert/pallKey.pem'),                                    // certificate and key for TLS  
        cert: fs.readFileSync('./cert/pallCer.cer')
    }
    
    const server = https.createServer(options, app);                                   // Express app object passed as callback here 
    
    server.listen(1000, ()=> console.log('Node server is listening!'));
    </pre>
    <p> - using Express.js through HTTP/2 (HTTPS) by <mark>spdy</mark> </p>
    <pre>
    const fs = require('fs');
    const spdy = require('spdy');                                                      // spdy module works just like http or http2 (awesome!)    
    const express = require('express');
    const app = express();
    
    app.use('/', express.static('/home/pall/Documents/CodePlus/My Site'));   
    
    var options = {
        key: fs.readFileSync('./cert/pallKey.pem'),                                    // certificate and key for TLS  
        cert: fs.readFileSync('./cert/pallCer.cer')
    }
    
    const server = spdy.createServer(options, app);                                    // Express app object passed as callback here    
    
    server.listen(1000, ()=> console.log('Spdy server is listening!'));
    </pre>
</details>  
    
    <br><br>
</body>
</html>
